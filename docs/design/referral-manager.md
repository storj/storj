# Referral Manager

## Abstract

This document describes how to handle referrals across satellites.

## Background

Current referral program only works per satellite, meaning a user on us-east-1 satellite can only refer people to join us-east-1.
For consistent experience we need to be able to handle cross-satellite referrals.

For a better user experience we also need to have a sign-up page where user can select Satellite during registration.

### Definitions

Referral Link
: A static link that contains a unique referral code.

Referral Code
: An uuid generated by Referral Manager program for each user to be able to participate in our referral program.

## Design

### User Flow

#### Sign up

1. Account Creation for user Alice:
	* Satellite verifies Referral Code using Referral Manager.
2. Account Activation:
	* Satellite B requests a Referral Code from Referral Manager.
	* Referral Manager generates a unique code XYZ, and then stores Satellite ID and XYZ in a database.
	* Referral Manager sends unique code XYZ to Satellite B.
	* Satellite B stores XYZ and user information in user table.
		* When Alice signed up without a referral link, then it is stores `NULL` in `referred_by`,
		* When Alice signed up with a referral link form Bonnie, then it stores Bonnies referral code in `referred_by`.

### Redeem referrer credits

After user Alice on satellite B pays their first invoice:

    Satellite B will send a request with the referral code, XYZ, to referral manager.

    Referral manager receives the request from satellite B and use the referral code, XYZ, to look up the satellite address that's associated with the referral code, XYZ, in its database.

    If no referral code can be found in referral manager's database that's equal to XYZ, referral manager sends back an INVALID response to satellite B.

    If a satellite address, C, is found in the database that's associated to the referral code XYZ, referral manager sends the referral code XYZ to satellite C. Satellite C looks up the user Bonnie that's associated with the referral code XYZ. satellite C injects a new entry into user_credits table for Bonnie for their earned referrer credits.

### Marketing admin GUI 

    Admin GUI is a web user interface that allows the marketing team to set different offers into the offers table (schema see below).
    
    Currently, each satellite has its own offers table in the satellitedb and marketing admin GUI.
    
    With the referral manager, we will migrate the existing offers table from satelites to the referral manager database.
    
## Rationale

1. Separation of concern
    * referral manager will handle all the referral logic, satellite will only store user's credit data.
    * marketing admin gui logic will be separate from the open source code.
    
2. Single source of truth
    * the marketing team does not need to go through each tardigrade satellite to set up the configuration for offers.

## Implementation

#### node id authentication
_to make sure that the node id the referral manager is talking to is one of our approved satellites_

````golang
var approvedSatellites  map[storj.NodeID]satelliteAddress
var mu sync.RWMutex
func VerifySatelliteID(ctx context.Context, id storj.NodeID) (err error) {
	if approvedSatellites {
		return nil
	}

	mu.RLock()
	defer mu.RUnlock()

	_, ok := approvedSatellites[id]
	if !ok {
		return fmt.Errorf("satellite %q is unapproved", id)
	}
	return nil
}
````


#### Referral Manager grpc Definition
````grpc
package referralmanager;

import "gogo.proto";

service ReferralManager {
    rpc Request(ReferralCodeRequest) returns (ReferralCodeResponse) {}
    rpc Validate(InformReferrerRequest) returns (InformReferrerResponse) {}
}

message ReferralCode {
    bytes satellite_id = 1 [(gogoproto.customtype) = "NodeID", (gogoproto.nullable) = false];
    string referral_code = 2;
}

message Offer{
    int credit
    google.protobuf.Timestamp expiration_date = 1 [(gogoproto.stdtime) = true, (gogoproto.nullable) = false];
}

message ReferralCodeRequest {
    bytes satellite_id = 1 [(gogoproto.customtype) = "NodeID", (gogoproto.nullable) = false];
    string user_id = 2;
}

message ReferralCodeResponse {
    enum Status {
        INVALID  = 0;
        SUCCESS = 1;
    }

    ReferralCode referral_code = 1;

    string user_id = 2;
    Offer offer = 3;

    Status status = 4;
}

message ValidateReferrerRequest {
    ReferralCode referral_code = 1;
}

message InformReferrerResponse {
    enum Status {
        INVALID = 0;
        SUCCESS = 1;
    }

    Status status = 1;
}
````

#### Satellite grpc Endpoint Definition
````grpc
package referral

service Referral {
    rpc Update(ReferralRequest) returns (ReferralResponse) {}
}

message Offer{
    int credit
    google.protobuf.Timestamp expiration_date = 1 [(gogoproto.stdtime) = true, (gogoproto.nullable) = false];
}

message ReferralRequest {
    strings referral_code = 1;
    strings user_id = 2;

    Offer offer = 3;

}

message ReferralResponse {
    enum Status {
        INVALID = 0;
        SUCCESS = 1;
    }

    Status status = 1;
}
````

#### SatelliteDB Change
1. Users Table
```sql
   referralCode blob
```

#### Referral Manager DB Design
1. table referral_codes
````sql
    referral_code blob PRIMARY KEY
    satellite_id blob
````

2. table satellite_info
````sql
    satellite_id blob PRIMARY KEY
    satellite_address text
````

3. table offers
````sql
    key id

	field id	serial
	field name text ( updatable )
	field description text ( updatable )

	field referrer_credit_in_cent int ( updatable, nullable )
	field invitee_credit_in_cent int ( updatable )

	field referrer_credit_duration_days int ( updatable, nullable )
	field invitee_credit_duration_days int ( updatable )

	field redeemable_cap int ( updatable, nullable )
    field num_redeemed int ( updatable, nullable )

    field partner_id blob ( nullable )

	field expires_at timestamp ( updatable, nullable )
	field created_at timestamp ( autoinsert )

	// status has three possible value: NoStatus="no-status", Default="default", Active="active".
	field status text ( updatable )
	// type has three possible value: FREE_CREDIT="free-credit", REFERRAL="referral", PARTNER="partner".
	field type text ( updatable )
````

## Open issues (if applicable)
1. How to keep num_redeemed up-to-date in real time?
