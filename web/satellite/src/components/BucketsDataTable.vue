// Copyright (C) 2023 Storj Labs, Inc.
// See LICENSE for copying information.

<template>
    <v-card>
        <v-text-field
            v-model="search"
            label="Search"
            :prepend-inner-icon="Search"
            single-line
            variant="solo-filled"
            flat
            hide-details
            clearable
            density="comfortable"
            rounded="lg"
            :maxlength="MAX_SEARCH_VALUE_LENGTH"
            class="mx-2 mt-2"
        />

        <v-data-table-server
            :sort-by="sortBy"
            :headers="headers"
            :items="displayedItems"
            :search="search"
            :loading="areBucketsFetching"
            :items-length="page.totalCount"
            items-per-page-text="Buckets per page"
            :items-per-page-options="tableSizeOptions(page.totalCount)"
            no-data-text="No buckets found"
            hover
            @update:itemsPerPage="onUpdateLimit"
            @update:page="onUpdatePage"
            @update:sortBy="onUpdateSort"
        >
            <template #item.name="{ item }">
                <v-btn
                    class="rounded-lg w-100 px-1 ml-n1 justify-start"
                    variant="text"
                    height="40"
                    color="default"
                    :disabled="bucketsBeingDeleted.has(item.name)"
                    @click="openBucket(item.name)"
                >
                    <template #default>
                        <img class="mr-3" src="../assets/icon-bucket-tonal.svg" alt="Bucket">
                        <div class="max-width">
                            <p class="font-weight-bold text-lowercase text-truncate">{{ item.name }}</p>
                        </div>
                    </template>
                </v-btn>
            </template>
            <template #item.storage="{ item }">
                <span>
                    {{ Size.toBase10String(item.storage * Memory.GB) }}
                </span>
            </template>
            <template #item.egress="{ item }">
                <span>
                    {{ item.egress.toFixed(2) + 'GB' }}
                </span>
            </template>
            <template #item.objectCount="{ item }">
                <span>
                    {{ item.objectCount.toLocaleString() }}
                </span>
            </template>
            <template #item.segmentCount="{ item }">
                <span>
                    {{ item.segmentCount.toLocaleString() }}
                </span>
            </template>
            <template #item.since="{ item }">
                <span class="text-no-wrap">
                    {{ Time.formattedDate(item.since) }}
                </span>
            </template>
            <template #item.location="{ item }">
                <div class="text-no-wrap">
                    <v-icon size="28" class="mr-1 pa-1 rounded-lg border">
                        <component :is="item.location === 'global' ? Earth : LandPlot" :size="18" />
                    </v-icon>
                    <v-chip variant="tonal" color="default" size="small" class="text-capitalize">
                        {{ item.location || `unknown(${item.defaultPlacement})` }}
                    </v-chip>
                </div>
            </template>
            <template #item.versioning="{ item }">
                <div class="text-no-wrap">
                    <v-tooltip location="top" :text="getVersioningInfo(item.versioning)">
                        <template #activator="{ props }">
                            <v-icon v-bind="props" size="28" :icon="getVersioningIcon(item.versioning)" class="mr-1 pa-1 rounded-lg border" />
                        </template>
                    </v-tooltip>
                    <v-chip variant="tonal" color="default" size="small">
                        {{ item.versioning }}
                    </v-chip>
                </div>
            </template>
            <template #item.actions="{ item }">
                <v-tooltip v-if="bucketsBeingDeleted.has(item.name)" location="top" text="Deleting bucket">
                    <template #activator="{ props }">
                        <v-progress-circular width="2" size="22" color="error" indeterminate v-bind="props" />
                    </template>
                </v-tooltip>
                <v-menu v-else location="bottom end" transition="scale-transition">
                    <template #activator="{ props: activatorProps }">
                        <v-btn
                            title="Bucket Actions"
                            :icon="Ellipsis"
                            color="default"
                            variant="outlined"
                            size="small"
                            rounded="md"
                            density="comfortable"
                            v-bind="activatorProps"
                        />
                    </template>
                    <v-list class="pa-1">
                        <v-list-item
                            density="comfortable"
                            link
                            @click="openBucket(item.name)"
                        >
                            <template #prepend>
                                <component :is="ArrowRight" :size="18" />
                            </template>
                            <v-list-item-title
                                class="ml-3 text-body-2 font-weight-medium"
                            >
                                Open Bucket
                            </v-list-item-title>
                        </v-list-item>
                        <div>
                            <v-list-item
                                v-if="versioningUIEnabled && item.versioning !== Versioning.NotSupported"
                                density="comfortable"
                                link
                                :disabled="item.versioning === Versioning.Enabled && item.objectLockEnabled"
                                @click="() => onToggleVersioning(item)"
                            >
                                <template #prepend>
                                    <component :is="History" v-if="item.versioning !== Versioning.Enabled" :size="18" />
                                    <component :is="CirclePause" v-else :size="18" />
                                </template>
                                <v-list-item-title class="ml-3">
                                    {{ item.versioning !== Versioning.Enabled ? 'Enable Versioning' : 'Suspend Versioning' }}
                                </v-list-item-title>
                            </v-list-item>
                            <v-tooltip
                                v-if="item.versioning === Versioning.Enabled && item.objectLockEnabled"
                                activator="parent"
                                location="left"
                                max-width="300"
                            >
                                Versioning cannot be suspended on a bucket with object lock enabled
                            </v-tooltip>
                        </div>
                        <v-list-item link @click="() => showShareBucketDialog(item.name)">
                            <template #prepend>
                                <component :is="Share" :size="18" />
                            </template>
                            <v-list-item-title class="ml-3">
                                Share Bucket
                            </v-list-item-title>
                        </v-list-item>
                        <v-list-item link @click="() => showBucketDetailsModal(item.name)">
                            <template #prepend>
                                <component :is="ReceiptText" :size="18" />
                            </template>
                            <v-list-item-title class="ml-3">
                                Bucket Details
                            </v-list-item-title>
                        </v-list-item>
                        <v-divider class="my-1" />
                        <v-list-item class="text-error text-body-2" link @click="() => showDeleteBucketDialog(item.name)">
                            <template #prepend>
                                <component :is="Trash2" :size="18" />
                            </template>
                            <v-list-item-title class="ml-3">
                                Delete Bucket
                            </v-list-item-title>
                        </v-list-item>
                    </v-list>
                </v-menu>
            </template>
        </v-data-table-server>
    </v-card>
    <delete-bucket-dialog v-model="isDeleteBucketDialogShown" :bucket-name="bucketToDelete" />
    <enter-bucket-passphrase-dialog v-model="isBucketPassphraseDialogOpen" @passphraseEntered="passphraseDialogCallback" />
    <share-dialog v-model="isShareBucketDialogShown" :bucket-name="shareBucketName" />
    <bucket-details-dialog v-model="isBucketDetailsDialogShown" :bucket-name="bucketDetailsName" />
    <toggle-versioning-dialog v-model="bucketToToggleVersioning" @toggle="fetchBuckets" />
</template>

<script setup lang="ts">
import { computed, FunctionalComponent, onBeforeUnmount, onMounted, ref, watch } from 'vue';
import { useRouter } from 'vue-router';
import {
    VBtn,
    VCard,
    VChip,
    VDataTableServer,
    VDivider,
    VIcon,
    VList,
    VListItem,
    VListItemTitle,
    VMenu,
    VProgressCircular,
    VTextField,
    VTooltip,
} from 'vuetify/components';
import {
    CircleCheck,
    CircleHelp,
    CircleMinus,
    CirclePause,
    CircleX,
    Ellipsis,
    Search,
    ReceiptText,
    Share,
    Trash2,
    ArrowRight,
    Earth,
    History,
    LandPlot,
} from 'lucide-vue-next';

import { Memory, Size } from '@/utils/bytesSize';
import { Bucket, BucketCursor, BucketMetadata, BucketPage } from '@/types/buckets';
import { useBucketsStore } from '@/store/modules/bucketsStore';
import { useConfigStore } from '@/store/modules/configStore';
import { useNotify } from '@/utils/hooks';
import { AnalyticsErrorEventSource } from '@/utils/constants/analyticsEventNames';
import { useProjectsStore } from '@/store/modules/projectsStore';
import { DEFAULT_PAGE_LIMIT } from '@/types/pagination';
import { tableSizeOptions, MAX_SEARCH_VALUE_LENGTH, DataTableHeader } from '@/types/common';
import { EdgeCredentials } from '@/types/accessGrants';
import { ROUTES } from '@/router';
import { usePreCheck } from '@/composables/usePreCheck';
import { Versioning } from '@/types/versioning';
import { Time } from '@/utils/time';
import { useObjectBrowserStore } from '@/store/modules/objectBrowserStore';

import DeleteBucketDialog from '@/components/dialogs/DeleteBucketDialog.vue';
import EnterBucketPassphraseDialog from '@/components/dialogs/EnterBucketPassphraseDialog.vue';
import ShareDialog from '@/components/dialogs/ShareDialog.vue';
import BucketDetailsDialog from '@/components/dialogs/BucketDetailsDialog.vue';
import ToggleVersioningDialog from '@/components/dialogs/ToggleVersioningDialog.vue';

const bucketsStore = useBucketsStore();
const obStore = useObjectBrowserStore();
const projectsStore = useProjectsStore();
const configStore = useConfigStore();

const notify = useNotify();
const router = useRouter();
const { withTrialCheck, withManagedPassphraseCheck } = usePreCheck();

const FIRST_PAGE = 1;
const areBucketsFetching = ref<boolean>(true);
const search = ref<string>('');
const searchTimer = ref<NodeJS.Timeout>();
const bucketDetailsName = ref<string>('');
const shareBucketName = ref<string>('');
const isDeleteBucketDialogShown = ref<boolean>(false);
const bucketToDelete = ref<string>('');
const isBucketPassphraseDialogOpen = ref(false);
const isShareBucketDialogShown = ref<boolean>(false);
const isBucketDetailsDialogShown = ref<boolean>(false);
const pageWidth = ref<number>(document.body.clientWidth);
const sortBy = ref<SortItem[] | undefined>([{ key: 'name', order: 'asc' }]);
const bucketToToggleVersioning = ref<BucketMetadata | null>(null);

let passphraseDialogCallback: () => void = () => {};

type SortItem = {
    key: keyof Bucket;
    order: boolean | 'asc' | 'desc';
}

const displayedItems = computed<Bucket[]>(() => {
    const items = page.value.buckets;

    sort(items, sortBy.value);

    return items;
});

const showRegionTag = computed<boolean>(() => {
    return configStore.state.config.enableRegionTag;
});

/**
 * Whether versioning has been enabled for current project.
 */
const versioningUIEnabled = computed(() => projectsStore.versioningUIEnabled);

const isTableSortable = computed<boolean>(() => {
    return page.value.totalCount <= cursor.value.limit;
});

const headers = computed<DataTableHeader[]>(() => {
    const hdrs: DataTableHeader[] = [
        {
            title: 'Bucket',
            align: 'start',
            key: 'name',
            sortable: isTableSortable.value,
        },
        { title: 'Objects', key: 'objectCount', sortable: isTableSortable.value },
        { title: 'Segments', key: 'segmentCount', sortable: isTableSortable.value },
        { title: 'Storage', key: 'storage', sortable: isTableSortable.value },
        { title: 'Download', key: 'egress', sortable: isTableSortable.value },
    ];

    if (showRegionTag.value) {
        hdrs.push({ title: 'Location', key: 'location', sortable: isTableSortable.value });
    }

    if (versioningUIEnabled.value) {
        hdrs.push({ title: 'Versioning', key: 'versioning', sortable: isTableSortable.value });
    }

    hdrs.push(
        { title: 'Date Created', key: 'since', sortable: isTableSortable.value },
        { title: '', key: 'actions', width: '0', sortable: false },
    );

    return hdrs;
});

/**
 * Returns buckets cursor from store.
 */
const cursor = computed((): BucketCursor => {
    return bucketsStore.state.cursor;
});

/**
 * Returns buckets page from store.
 */
const page = computed((): BucketPage => {
    return bucketsStore.state.page;
});

/**
 * Returns condition if user has to be prompt for passphrase from store.
 */
const promptForPassphrase = computed((): boolean => {
    return bucketsStore.state.promptForPassphrase;
});

/**
 * Returns selected bucket's name from store.
 */
const selectedBucketName = computed((): string => {
    return bucketsStore.state.fileComponentBucketName;
});

/**
 * Returns edge credentials from store.
 */
const edgeCredentials = computed((): EdgeCredentials => {
    return bucketsStore.state.edgeCredentials;
});

/**
 * Returns buckets being deleted from store.
 */
const bucketsBeingDeleted = computed((): Set<string> => bucketsStore.state.bucketsBeingDeleted);

/**
 * Fetches bucket using api.
 */
async function fetchBuckets(page = FIRST_PAGE, limit = DEFAULT_PAGE_LIMIT): Promise<void> {
    try {
        await bucketsStore.getBuckets(page, projectsStore.state.selectedProject.id, limit);
        if (areBucketsFetching.value) areBucketsFetching.value = false;
    } catch (error) {
        notify.error(`Unable to fetch buckets. ${error.message}`, AnalyticsErrorEventSource.BUCKET_TABLE);
    }
}

/**
 * Sorts items by provided sort options.
 * We use this to correctly sort columns by value of correct type.
 * @param items
 * @param sortOptions
 */
function sort(items: Bucket[], sortOptions: SortItem[] | undefined): void {
    if (!(sortOptions && sortOptions.length)) {
        items.sort((a, b) => a.name.localeCompare(b.name));
        return;
    }

    const option = sortOptions[0];

    switch (option.key) {
    case 'egress':
        items.sort((a, b) => option.order === 'asc' ? a.egress - b.egress : b.egress - a.egress);
        break;
    case 'storage':
        items.sort((a, b) => option.order === 'asc' ? a.storage - b.storage : b.storage - a.storage);
        break;
    case 'objectCount':
        items.sort((a, b) => option.order === 'asc' ? a.objectCount - b.objectCount : b.objectCount - a.objectCount);
        break;
    case 'segmentCount':
        items.sort((a, b) => option.order === 'asc' ? a.segmentCount - b.segmentCount : b.segmentCount - a.segmentCount);
        break;
    case 'location':
        items.sort((a, b) => option.order === 'asc' ? a.location.localeCompare(b.location) : b.location.localeCompare(a.location));
        break;
    case 'versioning':
        items.sort((a, b) => option.order === 'asc' ? a.versioning.localeCompare(b.versioning) : b.versioning.localeCompare(a.versioning));
        break;
    case 'since':
        items.sort((a, b) => option.order === 'asc' ? a.since.getTime() - b.since.getTime() : b.since.getTime() - a.since.getTime());
        break;
    default:
        items.sort((a, b) => option.order === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name));
    }
}

/**
 * Toggles versioning for the bucket between Suspended and Enabled.
 */
async function onToggleVersioning(bucket: Bucket) {
    withTrialCheck(() => { withManagedPassphraseCheck(() => {
        bucketToToggleVersioning.value = new BucketMetadata(bucket.name, bucket.versioning);
    });});
}

/**
 * Returns helper info based on versioning status.
 */
function getVersioningInfo(status: Versioning): string {
    switch (status) {
    case Versioning.Enabled:
        return 'Version history saved for all objects.';
    case Versioning.Suspended:
        return 'Versioning is currently suspended.';
    case Versioning.NotSupported:
        return 'Versioning is not supported for this bucket.';
    case Versioning.Unversioned:
        return 'This bucket does not have versioning enabled.';
    default:
        return 'Unknown versioning status.';
    }
}

/**
 * Returns icon based on versioning status.
 */
function getVersioningIcon(status: Versioning): FunctionalComponent {
    switch (status) {
    case Versioning.Enabled:
        return CircleCheck;
    case Versioning.Suspended:
        return CirclePause;
    case Versioning.NotSupported:
        return CircleX;
    case Versioning.Unversioned:
        return CircleMinus;
    default:
        return CircleHelp;
    }
}

/**
 * Handles update table rows limit event.
 */
function onUpdateLimit(limit: number): void {
    fetchBuckets(FIRST_PAGE, limit);
}

/**
 * Handles update table page event.
 */
function onUpdatePage(page: number): void {
    fetchBuckets(page, cursor.value.limit);
}

/**
 * Handles update table sorting event.
 */
function onUpdateSort(value: SortItem[]): void {
    sortBy.value = value;
}

/**
 * Navigates to bucket page.
 */
function openBucket(bucketName: string): void {
    withTrialCheck(async () => {withManagedPassphraseCheck(async () => {
        if (!bucketName) {
            return;
        }
        bucketsStore.setFileComponentBucketName(bucketName);
        if (!promptForPassphrase.value) {
            if (!edgeCredentials.value.accessKeyId) {
                try {
                    await bucketsStore.setS3Client(projectsStore.state.selectedProject.id);
                } catch (error) {
                    notify.notifyError(error, AnalyticsErrorEventSource.BUCKET_TABLE);
                    return;
                }
            }

            const objCount = bucketsStore.state.page.buckets?.find((bucket) => bucket.name === bucketName)?.objectCount ?? 0;
            obStore.setObjectCountOfSelectedBucket(objCount);

            await router.push({
                name: ROUTES.Bucket.name,
                params: {
                    browserPath: bucketsStore.state.fileComponentBucketName,
                    id: projectsStore.state.selectedProject.urlId,
                },
            });
            return;
        }
        passphraseDialogCallback = () => openBucket(selectedBucketName.value);
        isBucketPassphraseDialogOpen.value = true;
    });});
}

/**
 * Displays the Bucket Details dialog.
 */
function showBucketDetailsModal(bucketName: string): void {
    bucketDetailsName.value = bucketName;
    isBucketDetailsDialogShown.value = true;
}

/**
 * Displays the Delete Bucket dialog.
 */
function showDeleteBucketDialog(bucketName: string): void {
    bucketToDelete.value = bucketName;
    isDeleteBucketDialogShown.value = true;
}

/**
 * Displays the Share Bucket dialog.
 */
function showShareBucketDialog(bucketName: string): void {
    withTrialCheck(() => { withManagedPassphraseCheck(() => {
        shareBucketName.value = bucketName;
        if (promptForPassphrase.value) {
            bucketsStore.setFileComponentBucketName(bucketName);
            isBucketPassphraseDialogOpen.value = true;
            passphraseDialogCallback = () => isShareBucketDialogShown.value = true;
            return;
        }
        isShareBucketDialogShown.value = true;
    });});
}

/**
 * Handles page width change.
 */
function resizeHandler(): void {
    pageWidth.value = document.body.clientWidth;
}

/**
 * Handles update table search.
 */
watch(() => search.value, () => {
    clearTimeout(searchTimer.value);

    searchTimer.value = setTimeout(() => {
        bucketsStore.setBucketsSearch(search.value || '');
        fetchBuckets();
    }, 500); // 500ms delay for every new call.
});

watch(() => page.value.totalCount, () => {
    sortBy.value = [{ key: 'name', order: 'asc' }];
});

onMounted(() => {
    window.addEventListener('resize', resizeHandler);

    fetchBuckets();
});

onBeforeUnmount(() => {
    window.removeEventListener('resize', resizeHandler);
    bucketsStore.setBucketsSearch('');
});
</script>

<style scoped lang="scss">
.max-width {
    max-width: 250px;

    @media screen and (width <= 780px) {
        max-width: 400px;
    }

    @media screen and (width <= 620px) {
        max-width: 300px;
    }

    @media screen and (width <= 490px) {
        max-width: 200px;
    }

    @media screen and (width <= 385px) {
        max-width: 100px;
    }
}
</style>
