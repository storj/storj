// Copyright (C) 2024 Storj Labs, Inc.
// See LICENSE for copying information.

package satellitedb

import (
	"strconv"
	"strings"

	"storj.io/storj/private/migrate"
	"storj.io/storj/shared/dbutil/spannerutil"
)

// SpannerExtraStatements contains the list of queries needed to setup spanner satellite database.
//
// TODO: make this a nicer implementation.
var SpannerExtraStatements = (func() []string {
	x := &satelliteDB{}
	migration := x.testMigrationSpanner()

	step := migration.Steps[0]
	sql := step.Action.(migrate.SQL)[0]

	sql = strings.TrimPrefix(sql, "-- AUTOGENERATED BY storj.io/dbx\n")
	sql = strings.TrimPrefix(sql, "-- DO NOT EDIT\n")
	sql = strings.Trim(sql, "\n ;")

	statements := spannerutil.MustSplitSQLStatements(sql)

	statements = append(statements,
		`CREATE TABLE IF NOT EXISTS `+migration.Table+` (version INT64, commited_at STRING(MAX)) PRIMARY KEY (version)`) //nolint:misspell
	statements = append(statements,
		`INSERT INTO `+migration.Table+`(version, commited_at) VALUES (`+strconv.Itoa(step.Version)+`, '')`) //nolint:misspell

	for i, statement := range statements {
		statements[i] = strings.TrimSpace(statement)
	}

	return statements
})()
